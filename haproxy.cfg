# HAProxy Configuration для Shield
# Сохраните как /etc/haproxy/haproxy.cfg

global
    maxconn 50000
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Настройки SSL (если нужно)
    # ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    # ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client  1m
    timeout server  1m
    maxconn 50000

# Статистика HAProxy
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Frontend для Minecraft (порт по умолчанию)
frontend minecraft_frontend
    bind *:25565
    mode tcp
    option tcplog

    # Лимиты для защиты от SYN flood
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_len gt 0 }

    # Логирование подключений
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"

    default_backend shield_backend

# Backend для Shield
backend shield_backend
    mode tcp
    balance roundrobin

    # Проверка здоровья
    option tcp-check

    # ВАЖНО: send-proxy-v2 отправляет PROXY protocol v2 заголовок
    server shield1 127.0.0.1:25577 send-proxy-v2 check inter 2s fall 3 rise 2

    # Если у вас несколько инстансов Shield (для масштабирования):
    # server shield2 127.0.0.1:25578 send-proxy-v2 check inter 2s fall 3 rise 2

# Альтернативная конфигурация с защитой от connection flood
frontend minecraft_frontend_protected
    bind *:25565
    mode tcp
    option tcplog

    # Rate limiting на уровне HAProxy
    stick-table type ip size 1m expire 10s store conn_rate(10s)
    tcp-request connection track-sc0 src
    tcp-request connection reject if { src_conn_rate gt 10 }

    # Отклонение слишком быстрых подключений
    acl conn_rate_abuse src_conn_rate gt 10
    tcp-request connection reject if conn_rate_abuse

    default_backend shield_backend

# Конфигурация для нескольких Minecraft серверов
frontend minecraft_multi_frontend
    bind *:25565
    mode tcp

    # Используем SNI для маршрутизации (если используется BungeeCord/Velocity)
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    # Маршрутизация на основе SNI
    use_backend shield_backend_server1 if { req_ssl_sni -i server1.example.com }
    use_backend shield_backend_server2 if { req_ssl_sni -i server2.example.com }

    default_backend shield_backend

backend shield_backend_server1
    mode tcp
    server shield1 127.0.0.1:25577 send-proxy-v2 check

backend shield_backend_server2
    mode tcp
    server shield2 127.0.0.1:25578 send-proxy-v2 check

